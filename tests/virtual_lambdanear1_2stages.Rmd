---
title: "VirtualSpecies"
author: "Michelle DePrenger-Levin"
date: "2/14/2021"
output: html_document
---

```{r}
library(popbio)
library(ggplot2)
library(devtools)
library(popdemo)
# library(ggtern)
library(patchwork)
library(Ternary)
rm(list=ls())
```


# Rare plants from Salguero-Gomez et al. 2016
# Keyfitz' entropy < 1, Type I, K-selected species, low juvenile mortality with most individuals living to an old age. 

#Trade-off between survival and fecundity from Takada and Kawai (2020) 

# ------------------------------------------------ constrain lambda ---------------------------
# functions 
# Takada and Kawai 2020; s would be s_33
# Convex for semelparous - see Farrell 2020 and Takada and Kawai 2020
```{r}
# Concave for iteroparous from Takada and Kawai 2020 
itero_fecundsurv <- function(s){
  -12.5*((s + 0.1)^2) + 10.125
}

semel_fecundsurv <- function(s){
  12.5*((s - 0.9)^2) - 0.125
}

## Stasis: survival - treat this as less than perfect survival, need some juvenile mortality 
# Fujiwara and Diaz-Lopez 2017 
# The x's represent the median age of the stage class
# Salguero-Gomez has signs flipped, type I is the area where rare plants fall; equation 2 from Fujiwara and Diaz-Lopez 2017; hazard is
# h(x) = alpha2*exp(beta2*x); exponentially increasing risk of mortality with age, risk due to aging
survivalTypeI <- function(alpha2, beta2, x){
  exp((alpha2/beta2)*(1-(exp(beta2*x))))
}


survivalTypeIII <- function(alpha1,alpha3,beta3,x){
  exp(-alpha1*x) * exp((alpha3/beta3)*(1-exp(beta3 * x)))
}

```


Use survival curve to estimate along the curve, how many of the vegetative should survive and transition to the next stage class - i.e. reproductive
Then the length of time to or proportion that grow to reprodutive can be sped up or slowed down discounted by the survival to reproductive  
The wider the difference, the lower the transition should be
     S_11 * (1-G)   R
     G              S_22
```{r}
# Fujiwara and Diaz-Lopez 2017: Transition rate, matching duration
# that many survive to each additional year from first age of stage1 to first age of stage 2

# Kendall et al 2019: if stage duration are fixed (like only 1 year veg) mean stage duration equals the fixed stage duration in the life history. When variable - then the 
# growth is the fraction of individuals in the stage that have spent enough time to mature, depends on implicit age structure within the stage. When at stable stage distribution, the asymptotic growth rate is the observed population growth rate
# Need: (1) stage-specific mortality - how a cohort shrinks as it ages within a stage, (2) asymmptotic growth rate, the degree to which a cohort entering from previous stage in one year larger or smaller than the previous year under stable stage distribution
# iterative approach - guess at lambda, calculate growth, calculate dominant eigenvalue as the guess for lambda_1 (the observed lambda) and keep going until lambda stabilizes. 
# This is the fraction that mature from stage i
# The proportion that survives through the vegetative stage to the reproductive stage grow. However many will transition reduced by the average survival (some death) of indivduials in the stage
# Stationary age-within-stage structure (SAS) from Kendall et al 2019 and from Fujiwara Dias-Lopez 2017

# Age_first <- 2
# Age_last <- 3
# alpha2 <- 0.1
# beta2 <- 0.1
# rm(Age_first);rm(Age_last);rm(alpha2);rm(beta2)
Growth <- function(Age_first, Age_last, alpha2, beta2){
  # matching_duration <- 1-(1/(Age_first_2-Age_first_1))
  # 
  matching_proportion <- survivalTypeI(alpha2, beta2, (Age_last))/
    sum(survivalTypeI(alpha2,beta2,Age_first:Age_last))
  # matching_proportion *  prod(survivalTypeI(alpha2, beta2, 
  #                      Age_first_1:(Age_first_2 - 1)))^(1/((Age_first_2)-Age_first_1))
  matching_proportion * sum(survivalTypeI(alpha2, beta2, 
                       Age_first:Age_last))/(length(Age_first:Age_last))
  # prod(survivalTypeI(alpha2, beta2, 
                       # Age_first:Age_last))^(1/(Age_last - Age_first))
}

# The proportion that survive to the end of the vegetative stage are the ones that have remained vegetative
# Stasis <- function(Age_first, Age_last, alpha2, beta2){
#   survivalTypeI(alpha2, beta2, Age_last)/sum(survivalTypeI(alpha2, beta2, Age_first:Age_last))
# }

# stage-specific survival rate geometric mean, but if they all transition. The fraction that mature but do not grow 
# Fixed and 100 percent grow if age veg is only 1 year. some stay when 2 or more
# Fujiwara and Diaz-Lopez 2017 point out that some stage-transition are age-independent as in some plants but are not addressed in their paper. 
# Age_first <- 5
# Age_last <- 10
# alpha2 <- 0.1
# beta2 <- 0.1
# rm(Age_first);rm(Age_last);rm(alpha2);rm(beta2)
Stasis <- function(Age_first, Age_last, alpha2, beta2){
  # sum(survivalTypeI(alpha2, beta2, (Age_first+1):Age_last))/(Age_last-Age_first)
  # if(Age_first < Age_last){
  #   0
  # } else {
  #   prod(survivalTypeI(alpha2, beta2,
  #                      Age_first:(Age_last-1)))^(1/((Age_last -1)- Age_first))
  # }
  if(Age_first < Age_last){
    stasis <- prod(unlist(lapply(Age_first:(Age_last -1), function(i){
      survivalTypeI(alpha2, beta2,i+1)/survivalTypeI(alpha2, beta2,i)
    })))
    } else stasis <- 0 
    stasis
}

# Growth+Stasis < 1
# define stage 1 and stage 2 as the *end* points, not the middle


# params <- paramsAll
# stage1 <- 5 #max(1,rpois(1,1))
# stage2 <- 10 #stage1 + max(2,rpois(1,1))
# minSurv <- 0.001
# maxSurv <- 0.4
# rm(params);rm(stage1);rm(stage2);rm(minSurv)
### Iteroparous ----------------------------------------------
MPM_itero <- function(params, stage1, stage2, maxSurv = 0.8, minSurv = 0.001){
  possibleParams <- params[params$a2b2 %in% params$a2b2[params$survival < 0.8 & 
                                                          params$survival > minSurv & params$age == stage1+1 &
                                                          !is.na(params$survival)],]
  possibleParams <- possibleParams[possibleParams$survival < maxSurv & possibleParams$age == stage1,]
  # S_all <- sapply(1:nrow(possibleParams),function(x){
  #   Stasis(alpha2 = possibleParams[x,1], beta2 = possibleParams[x,2], Age_first = 1, Age_last = stage1)
  #   })
  # # if vegetative is only the first year then 100 percent transition to reproductive
  # G_all <- sapply(1:nrow(possibleParams),function(x){
  #   Growth(alpha2 = possibleParams[x,1], beta2 = possibleParams[x,2],
  #          Age_first_1 = 1, Age_first_2 = stage1+1)
  #   })
  # params1 <- possibleParams[(S_all + G_all) < maxSurv,]
  params1 <- possibleParams
  i <- sample(1:nrow(params1),1)
  S <- Stasis(alpha2 = params1[i,1], beta2 = params1[i,2], Age_first = 1, Age_last = stage1)
  S2 <- Stasis(alpha2 = params1[i,1], beta2 = params1[i,2], Age_first = stage1+1, Age_last = stage2)
  # (f <- itero_fecundsurv(survivalTypeI(alpha2 = params1[i,1], beta2 = params1[i,2], x = stage1+1))) # first survival of rep
  # Kendall et al 2019: fecundity multiplied by the survival of the offspring for prebreeding census (i.e. f = b_x * sigma_0 where parent in class x produces b_x seed after the census which surviv to the end of the timestep at rate sigma_0)
  f <- itero_fecundsurv(S2) * survivalTypeI(alpha2 = params1[i,1], beta2 = params1[i,2], x = 1)
  (G <- Growth(alpha2 = params1[i,1], beta2 = params1[i,2],Age_first = 1, Age_last = stage1))
  t_ij <- matrix(c(S, G,
                   f, S2),
                 nrow = 2)
  print(t_ij)
  print(colSums(t_ij))
  (lambda1 <- lambda(t_ij))
  (e_ij <- popbio::elasticity(t_ij))
  survivalElast <- sum(e_ij[which(generic_mat == "L")])
  growthElast <- sum(e_ij[which(generic_mat == "G")])
  fecundElast <- sum(e_ij[which(generic_mat == "F")])
  listout <- list(t_ij,e_ij, data.frame(S = survivalElast, G = growthElast, R = fecundElast, lam = lambda1,
                                    gentim = generation.time(t_ij)), params1)
  return(listout)
}
```


### ie. Silvertown et al 1996 "Interpretation of Elasticity Matrices as an aid to the managment of plant populations for conservation"
```{r}
generic_mat <- matrix(c("L","G",
                        "F","L"), nrow = 2)
# Stasis 
which(generic_mat == "L")
# Growth
which(generic_mat == "G")
# Fecundity
which(generic_mat == "F")
```

```{r}
# Type 3
# paramsAllType3 <- do.call(rbind, lapply(seq(0,0.7, by=0.05), function(a1){
#   outa2 <- do.call(rbind, lapply(seq(0, 0.7, by = 0.05), function(a3){
#     outb3 <- do.call(rbind, lapply(seq(0,0.7, by=0.05), function(b3){
#       surv <- survivalTypeIII(a1, a3, b3, x =seq(0.5,30,by=0.5))
#       data.frame(a1, a3, b3, age = seq(0.5,30,by=0.5), survival = surv, a1a3b3 = paste(a1,a3,b3,sep=""))
#       }))
#     }))
#   }))


# Type 1
paramsAll <- do.call(rbind, lapply(seq(0.01,1, by=0.01), function(a2){
  outb2 <- do.call(rbind, lapply(seq(0.01,1, by=0.01), function(b2){
    surv <- survivalTypeI(a2, b2, 1:30)
    data.frame(a2, b2, age = 1:30, survival = surv, a2b2 = paste(a2,b2,sep=""))
  }))
}))
```


# Iteroparous fast
```{r}
# ------------------ Iteroparous fast ------------------------
# hist(rpois(100,2))
# max(rpois(1000,2))
set.seed(123)
itfast <- lapply(1:100, function(x){ 
  stage1 <- max(1,rpois(1,1))
  stage2 <- stage1 + max(2,rpois(1,1))
  print(paste(stage1, stage2))
  # MPM_itero(params_itero, stage1 = stage1, stage2 = stage2)
  MPM_itero(paramsAll, stage1 = stage1, stage2 = stage2, maxSurv = 0.35, minSurv = 0.001) # from 0.4
  })
MPMs_itfast <- lapply(itfast, function(x) x[[1]]) # The first item is the MPM
lamitfast <-data.frame(do.call(rbind, lapply(itfast, function(x) x[[3]])), parity = "itero", speed = "fast") 
median(lamitfast$lam)
mean(lamitfast$lam)
sd(lamitfast$lam)
generation.time(mean(MPMs_itfast))

layout(matrix(c(1,2,3,4), 2,2),widths = c(6,2), heights = c(2,6))

  # Plot 1 density generation time
    den <- density(lamitfast$gentim)
    par(mar=c(0,4,0,0))
    plot(den$x, den$y, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red")
  # Plot 2 scatter plot
    par(mar=c(4,4,0,0))
    plot(lamitfast$gentim,lamitfast$lam, ylab = expression(lambda), xlab = "generation time",
         main = "", pch = 1, col = "red")
    mtext("a)", 3, line = 0.5,adj = 0)
  # Plot 3 blank
    frame()
  # Plot 4 lambda density
    den <- density(lamitfast$lam)
    par(mar=c(4,0,0,0))
    plot(den$y, den$x, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red")
    
# dev.off()
# ---------------------------------------------
```

```{r}
params_itero_fast <- do.call(rbind,lapply(itfast, function(x) x[[4]]))
params_itero_fast <- params_itero_fast[!duplicated(params_itero_fast[,1:2]),]
dev.off()



plot(0:26, survivalTypeI(params_itero_fast[1,1], params_itero_fast[1,2], 0:26), type = "l", 
     col = rainbow(nrow(params_itero_fast), alpha = 0.5)[1],
     # xlab = "",xaxt = "n", 
     xlab = "Age in years",
     ylab = "Survival (stasis)",
     ylim = c(0,1))
for(i in 2:nrow(params_itero_fast)){
  lines(0:26, survivalTypeI(params_itero_fast[i,1], params_itero_fast[i,2], 0:26), type = "l", 
        col = rainbow(nrow(params_itero_fast), alpha = 0.5)[i])
}

```

```{r}
#Elasticities
dev.off()
Elasts_itfast <- data.frame(do.call(rbind,lapply(itfast, function(x) x[[3]])),
                            parity = "iteroparous", speed = "fast")
Elasts_itfast_points <- lapply(itfast, function(x) as.numeric(x[[3]][,c("G","S","R")])) # in abc format each a vector of three

min(Elasts_itfast$R)
max(Elasts_itfast$R)
min(Elasts_itfast$G)
max(Elasts_itfast$G)

min(Elasts_itfast$S)
max(Elasts_itfast$S)
par(mar = c(0,0,0,0))
Ternary::TernaryPlot(point = "up",
                     atip = "G",
                     btip = "S",
                     ctip = "R",
                     alab = "Growth \u2192", blab = "Stasis \u2192", clab = "\u2190 fecundity", # with arrows
                     grid.minor.lines = 0)
AddToTernary(points, Elasts_itfast_points, pch = 21)

 # ggtern::ggtern(Elasts_itfast, aes(R, G, S, colour = lam))+ #, size = floor(gentim)))+ #, size = as.factor(floor(GenTime))))+ #lam))+
 #                  geom_point(shape = 16)+
 #                  scale_color_viridis_c(name = expression(lambda))+
 #   scale_size_continuous(name = "Generation time\n (years binned)")+
 #                  theme_showarrows()+
 #                  theme_clockwise()
              
```


# itero slow
```{r}

# ---------------------------- Iteroparous Slow ---------------------
# Ages are end points of age
set.seed(123)
itslow <- lapply(1:100, function(x){ 
  stage1 <- max(4,rpois(1,4))
  stage2 <- stage1 + max(3,rpois(1,5))
  MPM_itero(paramsAll, stage1 = stage1, stage2 = stage2,maxSurv = 0.56,minSurv = 0.1)
  })
MPMs_itslow <- lapply(itslow, function(x) x[[1]])

lamitslow <-data.frame(do.call(rbind, lapply(itslow, function(x) x[[3]])), parity = "itero", speed = "slow") 
median(lamitslow$lam)
mean(lamitslow$lam)
sd(lamitslow$lam)
generation.time(mean(MPMs_itslow))
mean(unlist(lapply(itslow, function(x) x[[3]]$gentim)))

params_itero_slow <- do.call(rbind,lapply(itslow, function(x) x[[4]]))
params_itero_slow <- params_itero_slow[!duplicated(params_itero_slow[,1:2]),]


matrixmetrics <- do.call(rbind, list(lamitslow, lamitfast))

# jpeg("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Itero_lambdagenerationtime.jpg",
#      width = 100, height = 100, units="mm", res = 300)

    layout(matrix(c(1,2,3,4), 2,2),widths = c(6,2), heights = c(2,6))

    # Plot 1 density generation time
      den <- density(matrixmetrics$gentim[matrixmetrics$speed == "fast"])
      denslow <- density(matrixmetrics$gentim[matrixmetrics$speed == "slow"])
      par(mar=c(0,4,0,0))
      plot(den$x, den$y, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "grey70",
           xlim = c(min(c(den$x, denslow$x)), max(c(den$x, denslow$x))),
           ylim = c(min(c(den$y, denslow$y)), max(c(den$y, denslow$y))))
      lines(denslow$x,denslow$y, col = "red",
           xlim = c(min(c(den$x, denslow$x)), max(c(den$x, denslow$x))),
           ylim = c(min(c(den$y, denslow$y)), max(c(den$y, denslow$y))))
    # Plot 2 scatter plot
      par(mar=c(4,4,0,0))
      plot(matrixmetrics$gentim[matrixmetrics$speed == "slow"],matrixmetrics$lam[matrixmetrics$speed == "slow"], 
           ylab = expression(lambda), xlab = "generation time",
           main = "", pch = 16, col = "red",
           xlim = c(min(matrixmetrics$gentim),max(matrixmetrics$gentim)),
           ylim = c(min(matrixmetrics$lam),max(matrixmetrics$lam)))
      points(matrixmetrics$gentim[matrixmetrics$speed == "fast"], 
             matrixmetrics$lam[matrixmetrics$speed == "fast"], pch = 2, col = "grey70")
      legend("topright", legend = c("slow","fast"), col = c("red","grey70"), pch = c(16,2))
      mtext("a)", 3, line = 0.5,adj = 0)
    # Plot 3 blank
      frame()
    # Plot 4 lambda density
      denlamfast <- density(matrixmetrics$lam[matrixmetrics$speed == "fast"])
      denlamslow <- density(matrixmetrics$lam[matrixmetrics$speed == "slow"])
      par(mar=c(4,0,0,0))
      plot(denlamfast$y, denlamfast$x, xlab = "",ylab="", main="", 
           xaxt = "n", yaxt = "n", type = "l",bty="n", col = "grey70",
           ylim = c(min(c(denlamfast$x, denlamslow$x)), max(c(denlamfast$x, denlamslow$x))),
           xlim = c(min(c(denlamfast$y, denlamslow$y)), max(c(denlamfast$y, denlamslow$y))))
      lines(denlamslow$y, denlamslow$x, col = "red")

# dev.off()
# ---------------------------------------------
```

```{r}
# Elasticities
Elasts_itslow <- data.frame(do.call(rbind,lapply(itslow, function(x) x[[3]])), 
                            parity = "iteroparous", speed = "slow")
Elasts_itslow_points <- lapply(itslow, function(x) as.numeric(x[[3]][,c("G","S","R")]))
# ggtern::ggtern(Elasts_itslow, aes(R, G, S, colour = lam))+
#   geom_point()+
#   scale_color_viridis_c(name = expression(lambda))+
#   theme_showarrows()+
#   theme_clockwise()

# IteroAll <- rbind(Elasts_itfast,Elasts_itslow)

# 
jpeg("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Itero_ternary.jpg",
     width = 200, height = 100, units="mm", res = 300)

cols <-  viridis(50, alpha = 0.75, begin = 0, end = 1)
minCol <- min(as.numeric(cut(Elasts_itfast$lam, breaks = 50)))
maxCol <- max(as.numeric(cut(Elasts_itfast$lam, breaks = 50)))

cols2 <- colorRampPalette(c("yellow","red"))


layout(matrix(c(1,1,2,1,1,3),ncol=3, byrow = TRUE), width = c(3,3,1),height = c(1,1))
par(mar = c(0,0,0,0))
        Ternary::TernaryPlot(point = "up",
                             atip = "G",
                             btip = "S",
                             ctip = "R",
                             alab = "Growth \u2192", blab = "Stasis \u2192", clab = "\u2190 fecundity", # with arrows
                             grid.minor.lines = 0) 
        AddToTernary(points, Elasts_itfast_points, pch = 16, 
                     col = cols[as.numeric(cut(Elasts_itfast$lam, breaks = 50))], cex = 2) 
        AddToTernary(points, Elasts_itslow_points, pch = 17, 
                     col = cols2(50)[as.numeric(cut(Elasts_itslow$lam, breaks = 50))], cex = 1) 
        legend("topright", legend = c("Iteroparous fast", "Iteroparous slow"),
                        pch = c(16,17), col = "black", cex = 1.25)
        par(mar = c(2,0,2,3))
        # fast legend
        legend_image <- as.raster(matrix(cols[1:50]), ncol=1)
        plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = expression("fast"~lambda))
        text(x=1.5, y = seq(0,1,l=5), labels = round(seq(min(Elasts_itfast$lam),max(Elasts_itfast$lam),l=5),2),
             cex = 1)
        rasterImage(legend_image, 0, 0, 1,1)
        # slow legend
        legend_image <- as.raster(matrix(cols2(50)), ncol=1)
        plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = expression("slow"~lambda))
        text(x=1.5, y = seq(0,1,l=5), labels = round(seq(min(Elasts_itslow$lam),max(Elasts_itslow$lam),l=5),2),
             cex = 1)
        rasterImage(legend_image, 0, 0, 1,1)
        
dev.off()

       
```

```{r}


#Test
# params <- paramsAll
# (stage1 <- max(1,rpois(1,1)))
# (stage2 <- stage1+1)
### Semelparous ----------------------------------------------
MPM_semel <- function(params, stage1, stage2, maxSurv = 0.2, minSurv = 0.001){
 possibleParams <- params[params$survival < maxSurv & params$survival > minSurv & params$age == stage1+1 &
                             !is.na(params$survival),]
 params1 <- possibleParams
 i <- sample(1:nrow(params1),1)
 S <- Stasis(alpha2 = params1[i,1], beta2 = params1[i,2], Age_first = 1, Age_last = stage1)
 (f <- itero_fecundsurv(survivalTypeI(alpha2 = params1[i,1], beta2 = params1[i,2], x = stage1+1))) # first survival of rep
  (G <- Growth(alpha2 = params1[i,1], beta2 = params1[i,2],Age_first_1 = 1, 
               Age_first_2 = stage1+1))
  t_ij <- matrix(c(S, G,
                   f, 0),
                 nrow = 2)
  print(colSums(t_ij))
  (lambda1 <- lambda(t_ij))
  (e_ij <- popbio::elasticity(t_ij))
  survivalElast <- sum(e_ij[which(generic_mat == "L")])
  growthElast <- sum(e_ij[which(generic_mat == "G")])
  fecundElast <- sum(e_ij[which(generic_mat == "F")])
  listout <- list(t_ij,e_ij, data.frame(S = survivalElast, G = growthElast, R = fecundElast, lam = lambda1,
                                    gentim = generation.time(t_ij)), params1)
  return(listout)
}
```

# semel fast
semelparous get to reproductive and die so stage 1 [1,7] is set and to be in the middle, stage 2 is one year double that of stage1 [2,14]
```{r}

# get 100 runs
set.seed(123)
sefast <- lapply(1:100, function(x){ 
  stage1 <- max(1,rpois(1,1))
  stage2 <- stage1+1
  MPM_semel(paramsAll, stage1 = stage1, stage2 = stage2, maxSurv = 0.4, minSurv = 0.02) # because want really low survival to drive up fecudity
  })
MPMs_sefast <- lapply(sefast, function(x) x[[1]]) # The first item is the MPM
lamsefast <-data.frame(do.call(rbind, lapply(sefast, function(x) x[[3]])), parity = "semel", speed = "fast") 
median(lamsefast$lam)
mean(lamsefast$lam)
sd(lamsefast$lam)
generation.time(mean(MPMs_sefast))


params_itero_slow <- do.call(rbind, lapply(sefast, function(x) x[[4]]))
# plot(0:26, survivalTypeI(params_semel[1,1], params_semel[1,2], 0:26), type = "l", 
#      col = rainbow(nrow(params_semel), alpha = 1)[1],
#      # xlab = "",xaxt = "n", 
#      xlab = "Age in years",
#      ylab = "Survival (stasis)",
#      ylim = c(0,1))
# for(i in 2:nrow(params_semel)){
#   lines(0:26, survivalTypeI(params_semel[i,1], params_semel[i,2], 0:26), type = "l", 
#         col = rainbow(nrow(params_semel), alpha = 1)[i])
# }


# ---------------------------------------------
layout(matrix(c(1,2,3,4), 2,2),widths = c(6,2), heights = c(2,6))

  # Plot 1 density generation time
    den <- density(lamsefast$gentim)
    par(mar=c(0,4,0,0))
    plot(den$x, den$y, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red")
  # Plot 2 scatter plot
    par(mar=c(4,4,0,0))
    plot(lamsefast$gentim,lamsefast$lam, ylab = expression(lambda), xlab = "generation time",
         main = "", pch = 1, col = "red")
    mtext("a) semelparous fast", 3, line = 0.5,adj = 0)
  # Plot 3 blank
    frame()
  # Plot 4 lambda density
    den <- density(lamsefast$lam)
    par(mar=c(4,0,0,0))
    plot(den$y, den$x, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red")
    
# dev.off()
# ---------------------------------------------
```

#Elasticities
```{r}
Elasts_sefast <- data.frame(do.call(rbind,lapply(sefast, function(x) x[[3]])), 
                            parity = "semelparous", speed = "fast")


Elasts_sefast_points <- lapply(sefast, function(x) as.numeric(x[[3]][,c("G","S","R")]))

Elasts_seall <- do.call(rbind, list(Elasts_sefast))
 # ggtern::ggtern(Elasts_sefast, aes(R, G, S, colour = lam, shape = speed))+ 
 #                  geom_point(shape = 1)+
 #                  scale_color_viridis_c(name = expression(lambda))+
 #   scale_shape_manual(name = "Speed")+
 #                  theme_showarrows()+
 #                  theme_clockwise()

 max(Elasts_sefast$S)
min(Elasts_sefast$S)
 max(Elasts_sefast$R)
min(Elasts_sefast$R)

par(mar = c(0,0,0,0))
        Ternary::TernaryPlot(point = "up",
                             atip = "G",
                             btip = "S",
                             ctip = "R",
                             alab = "Growth \u2192", blab = "Stasis \u2192", clab = "\u2190 fecundity", # with arrows
                             grid.minor.lines = 0) 
        AddToTernary(points, Elasts_sefast_points, pch = 16, 
                     col = cols[as.numeric(cut(Elasts_itfast$lam, breaks = 50))], cex = 2) 
        # AddToTernary(points, Elasts_itslow_points, pch = 17, 
        #              col = cols2(50)[as.numeric(cut(Elasts_itslow$lam, breaks = 50))], cex = 1) 
        legend("topright", legend = c("Semelparous fast", "Semelparous slow"),
                        pch = c(16,17), col = "black", cex = 1.25)
        
        
```



# Semel slow
```{r}
# ---------------------------- Semelparous Slow ---------------------
# hist(rpois(100,5))
# max(rpois(1000,3)) # about 13, so 26 as reproductive age
# max(rpois(1000, 5)) # Stage1 center when stage2 is just double stage 1
set.seed(123)
seslow <- lapply(1:100, function(x){ 
  stage1 <- max(10,rpois(1,7))
  stage2 <- stage1+1
  MPM_semel(paramsAll, stage1 = stage1, stage2 = stage2, maxSurv = 0.37, minSurv = 0.00001)
  })
# seslow <- lapply(1:100, function(x) MPM_semel(params = params_semel_slow, stage1 = stage1, stage2 = stage2))
MPMs_seslow <- lapply(seslow, function(x) x[[1]])

lamseslow <-data.frame(do.call(rbind, lapply(seslow, function(x) x[[3]])), parity = "semel", speed = "slow") 
median(lamseslow$lam)
mean(lamseslow$lam)
sd(lamseslow$lam)
generation.time(mean(MPMs_seslow))
mean(unlist(lapply(seslow, function(x) x[[3]]$gentim)))


# plot(0:26, survivalTypeI(params_semel[1,1], params_semel[1,2], 0:26), type = "l", 
#      col = rainbow(nrow(params_semel), alpha = 1)[1],
#      # xlab = "",xaxt = "n", 
#      xlab = "Age in years",
#      ylab = "Survival (stasis)",
#      ylim = c(0,1))
# for(i in 2:nrow(params_semel)){
#   lines(0:26, survivalTypeI(params_semel[i,1], params_semel[i,2], 0:26), type = "l", 
#         col = rainbow(nrow(params_semel), alpha = 1)[i])
# }

matrixmetrics <- do.call(rbind, list(lamseslow, lamsefast))
# matrixmetrics <- matrixmetrics[matrixmetrics$lam > 0.8 & matrixmetrics$lam < 1.2,]

# jpeg("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Semel_lambdagenerationtime.jpg",
#      width = 100, height = 100, units="mm", res = 300)

    layout(matrix(c(1,2,3,4), 2,2),widths = c(6,2), heights = c(2,6))

    # Plot 1 density generation time
      den <- density(matrixmetrics$gentim[matrixmetrics$speed == "fast"])
      denslow <- density(matrixmetrics$gentim[matrixmetrics$speed == "slow"])
      par(mar=c(0,4,0,0))
      plot(den$x, den$y, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red",
           xlim = c(min(c(den$x, denslow$x)), max(c(den$x, denslow$x))),
           ylim = c(min(c(den$y, denslow$y)), max(c(den$y, denslow$y))))
      lines(denslow$x,denslow$y, col = "grey70",
           xlim = c(min(c(den$x, denslow$x)), max(c(den$x, denslow$x))),
           ylim = c(min(c(den$y, denslow$y)), max(c(den$y, denslow$y))))
    # Plot 2 scatter plot
      par(mar=c(4,4,0,0))
      plot(matrixmetrics$gentim[matrixmetrics$speed == "slow"],matrixmetrics$lam[matrixmetrics$speed == "slow"], 
           ylab = expression(lambda), xlab = "generation time",
           main = "", pch = 16, col = "red",
           xlim = c(min(matrixmetrics$gentim),max(matrixmetrics$gentim)),
           ylim = c(min(matrixmetrics$lam),max(matrixmetrics$lam)))
      points(matrixmetrics$gentim[matrixmetrics$speed == "fast"], 
             matrixmetrics$lam[matrixmetrics$speed == "fast"], pch = 2, col = "grey70")
      legend("topright", legend = c("slow","fast"), col = c("red","grey70"), pch = c(16,2))
      mtext("b)", 3, line = 0.5,adj = 0)
    # Plot 3 blank
      frame()
    # Plot 4 lambda density
      denlamfast <- density(matrixmetrics$lam[matrixmetrics$speed == "fast"])
      denlamslow <- density(matrixmetrics$lam[matrixmetrics$speed == "slow"])
      par(mar=c(4,0,0,0))
      plot(denlamfast$y, denlamfast$x, xlab = "",ylab="", main="", 
           xaxt = "n", yaxt = "n", type = "l",bty="n", col = "grey70",
           ylim = c(min(c(denlamfast$x, denlamslow$x)), max(c(denlamfast$x, denlamslow$x))),
           xlim = c(min(c(denlamfast$y, denlamslow$y)), max(c(denlamfast$y, denlamslow$y))))
      lines(denlamslow$y, denlamslow$x, col = "red")

# dev.off()
# ---------------------------------------------
```

```{r}
# Elasticities
Elasts_seslow <- data.frame(do.call(rbind,lapply(seslow, function(x) x[[3]])), 
                            parity = "semelparous", speed = "slow")
ggtern::ggtern(Elasts_seslow, aes(R, G, S, colour = lam))+
  geom_point()+
  scale_color_viridis_c(name = expression(lambda))+
  theme_showarrows()+
  theme_clockwise()

SemelAll <- rbind(Elasts_sefast,Elasts_seslow)
SemelAll <- SemelAll[SemelAll$lam > 0.8 & SemelAll$lam < 1.2,]

ternSemel <- ggtern::ggtern(SemelAll, aes(R, G, S, colour = lam, shape = speed))+ #interaction(speed,parity)))+
            geom_point()+
            scale_color_viridis_c(name = expression(lambda))+
            scale_shape_manual(name = "Speed", values = c(16,2))+
            theme_showarrows()+
            theme_clockwise()
ggsave(filename =  "C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/TernarySemel.jpg",
       ternSemel,
       width=130, height=70,units='mm', dpi=300)
       
```


# Semelparous slow



# Heuristic of matrix creation
# ---------------------------------------------
```{r}
jpeg("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/SurvivalStasisFig1a.jpg",
     width = 175, height = 80, units="mm", res = 300)

layout(matrix(c(1,2,5,5,3,4,5,5),2,4, byrow=TRUE), widths = c(1,1,1,1), heights = c(1,1))
#### Iteroparous fast---------------------------------
par(mar = c(2,5,3,0))
plot(0:15, survivalTypeI(params_itero[1,1], params_itero[1,2], 0:15), type = "l", col = rainbow(nrow(params_itero), alpha = 1)[1],
     # xlab = "",xaxt = "n",
     xlab = "Age in years",
     ylab = "Survival",
     ylim = c(0,1))
for(i in 2:nrow(params_itero)){
  lines(0:15, survivalTypeI(params_itero[i,1], params_itero[i,2], 0:15), type = "l", col = rainbow(nrow(params_itero), alpha = 1)[i])
}
mtext("a) (S)tasis and (G)rowth", adj= 0.75, line = 1)
mtext("iteroparous", adj=0.5, cex = 0.75)
mtext("fast", adj=0.5, side = 2, line = 4)

#### semelparous fast---------------------------------
par(mar = c(2,3,3,2))
plot(0:15, survivalTypeI(params_semel[1,1], params_semel[1,2], 0:15), type = "l", col = rainbow(nrow(params_semel), alpha = 1)[1],
     xlab = "Age (years)", ylab = "", yaxt = "n",
     ylim = c(0,1))
for(i in 2:nrow(params_semel)){
  lines(0:15, survivalTypeI(params_semel[i,1], params_semel[i,2], 0:15), type = "l", 
        col = rainbow(nrow(params_semel), alpha = 1)[i])
}
mtext("semelparous", adj=0.5, cex = 0.75)

### itero slow
par(mar = c(4,5,1,0))
plot(0:15, survivalTypeI(params_itero_slow[1,1], params_itero_slow[1,2], 0:15), type = "l", col = rainbow(nrow(params_itero_slow), alpha = 1)[1],
     xlab = "Age (years)",
     ylab = "Survival",
     ylim = c(0,1))
for(i in 2:nrow(params_itero_slow)){
  lines(0:15, survivalTypeI(params_itero_slow[i,1], params_itero_slow[i,2], 0:15), type = "l", col = rainbow(nrow(params_itero_slow), alpha = 1)[i])
}
mtext("slow", adj=0.5, side = 2, line = 4)

#### semelparous slow---------------------------------
par(mar = c(4,3,1,2))
plot(0:15, survivalTypeI(params_semel_slow[1,1], params_semel_slow[1,2], 0:15), type = "l", 
     col = rainbow(nrow(params_semel_slow), alpha = 1)[1],
     xlab = "Age (years)", ylab = "", yaxt = "n",
     ylim = c(0,1))
for(i in 2:nrow(params_semel_slow)){
  lines(0:15, survivalTypeI(params_semel_slow[i,1], params_semel_slow[i,2], 0:15), type = "l",
        col = rainbow(nrow(params_semel_slow), alpha = 1)[i])
}


# Plot 5
par(mar=c(4,4,3,2))
plot(seq(0,1,by=0.1), xlim = c(0,0.8), ylim = c(0,10), semel_fecundsurv(seq(0,1,by=0.1)), type = "l", 
     ylab = "Fecundity (R)", xlab = expression("Adult survival (S"[22]~")"))
lines(seq(0,1,by=0.1), itero_fecundsurv(seq(0,1,by=0.1)))
text(0.6,7, "iteroparous")
text(0.2,3, "semelparous")
mtext("b) (R)eproduction", adj= -0.45, line = 1)


dev.off() 


```




# Elasticity space, survival of the reproductive stage
```{r}
elast_type <- data.frame(R = c(0.3, 0.2, 0.7, 0.025, 0.2, 0.01, 0.25, 0.05, 0.9,  0.4, 0.05, 0.6, 0.49, 0.01, 0.98, 0.4),
                         G = c(0.5, 0.4, 0.29, 0.025, 0.7, 0.6,  0.7,  0.65,0.05, 0.5, 0.7,  0.5, 0.49, 0.01, 0.01, 0.4),
                         S = c(0.2, 0.5, 0.01, 0.95,  0.1, 0.39, 0.05, 0.3, 0.05, 0.6, 0.25, 0.4, 0.02, 0.98, 0.01, 0.2),
                         Type = c("semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous"))

ggsave(filename =  "C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/TernaryPlotConceptual.jpg",
       ggtern::ggtern(elast_type, aes(R, G, S, colour = Type, fill = Type))+ # colour = parity, shape = speed))+label = Type, 
         # geom_point(size = 30, shape = 2)+
         # scale_color_viridis_c()+
         # geom_text(size=3.5)+
         # geom_polygon()+
         geom_mean_ellipse()+
         theme_showarrows()+
         theme_clockwise()+
         ggtitle("d)")
         # theme(legend.position = "none")
       , width=100, height = 70, units = 'mm', dpi = 300)

```





# -------------------------- UPDATED TO HERE ---------------------
# -------------------------- UPDATED TO HERE ---------------------
# -------------------------- UPDATED TO HERE ---------------------



# ------------------- Simulation runs ----------------------------
pathstartVirtual <-  "C:/Users/DePrengm/Denver Botanic Gardens/Conservation - Demography/SeedHarvestModelling/Seed_Harvest_Modeling/Simulation_output_virt_lambda_1/"

annuals <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(Nxstages = c(NA,NA,NA,1), StartPopSize = StPopSz, MatrixType = "annual" )
  save(out, file =  paste(pathstartVirtual,"annuals",StPopSz,".Rdata", sep=""))
  out
}))

iterofast <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(StartPopSize = StPopSz, MatrixType = "iterofast")
  save(out, file =  paste(pathstartVirtual,"iterofast",StPopSz,".Rdata", sep=""))
  out
}))

# error eigen(Abar) : non-square matrix in 'eigen'; Abar likely means mean(A) 
# When first thing went extinct, then mats[2:1] gave the one matrix and NULL 
iteroslow <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(StartPopSize = StPopSz, MatrixType = "iteroslow")
  save(out, file =  paste(pathstartVirtual,"iteroslow",StPopSz,".Rdata", sep=""))
  out
}))

semelfast <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(StartPopSize = StPopSz, MatrixType = "semelfast")
  save(out, file =  paste(pathstartVirtual,"semelfast",StPopSz,".Rdata", sep=""))
  out
}))

semelslow <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(StartPopSize = StPopSz, MatrixType = "semelslow")
  save(out, file =  paste(pathstartVirtual,"semelslow",StPopSz,".Rdata", sep=""))
  out
}))


---
title: "VirtualSpecies"
author: "Michelle DePrenger-Levin"
date: "2/14/2021"
output: html_document
---

```{r}
library(popbio)
library(ggplot2)
library(devtools)
library(popdemo)
library(ggtern)
library(patchwork)
rm(list=ls())
```


# Rare plants from Salguero-Gomez et al. 2016
# Keyfitz' entropy < 1, Type I, K-selected species, low juvenile mortality with most individuals living to an old age. 

#Trade-off between survival and fecundity from Takada and Kawai (2020) 

# ------------------------------------------------ constrain lambda ---------------------------
# functions 
# Takada and Kawai 2020; s would be s_33
# Convex for semelparous - see Farrell 2020 and Takada and Kawai 2020
```{r}
# Concave for iteroparous from Takada and Kawai 2020 
itero_fecundsurv <- function(s){
  -12.5*((s + 0.1)^2) + 10.125
}

plot(seq(0,0.8,0.1), itero_fecundsurv(seq(0,0.8,0.1)), type ="l")

semel_fecundsurv <- function(s){
  12.5*((s - 0.9)^2) - 0.125
}

lines(seq(0,0.8,0.1), semel_fecundsurv(seq(0,0.8,0.1)), col ="red")

## Stasis: survival - treat this as less than perfect survival, need some juvenile mortality 
# Fujiwara and Diaz-Lopez 2017 
# The x's represent the median age of the stage class
# Salguero-Gomez has signs flipped, type I is the area where rare plants fall; equation 2 from Fujiwara and Diaz-Lopez 2017; hazard is
# h(x) = alpha2*exp(beta2*x); exponentially increasing risk of mortality with age, risk due to aging
survivalTypeI <- function(alpha2, beta2, x){
  exp((alpha2/beta2)*(1-(exp(beta2*x))))
}

```


Use survival curve to estimate along the curve, how many of the vegetative should survive and transition to the next stage class - i.e. reproductive
Then the length of time to or proportion that grow to reprodutive can be sped up or slowed down discounted by the survival to reproductive  
The wider the difference, the lower the transition should be
     S_11 * (1-G)   R
     G              S_22
```{r}
# Fujiwara and Diaz-Lopez 2017: Transition rate, matching duration
Growth <- function(Age_first_1, Age_first_2, alpha2, beta2){
  # matching_duration <- 1-(1/(Age_first_2-Age_first_1))
  matching_proportion <- survivalTypeI(alpha2, beta2, Age_first_2)/
    sum(survivalTypeI(alpha2,beta2,Age_first_1:Age_first_2))
  matching_proportion
}

### Iteroparous ----------------------------------------------
MPM_itero <- function(params, stage1, stage2){
  # three juvenile stages, one reproductive
  i <- sample(1:nrow(params),1)
  (s_s <- survivalTypeI(alpha2 = params[i,1], beta2 = params[i,2], c(stage1,stage2))) 
  (f <- itero_fecundsurv(s_s[2]))
  (G <- Growth(alpha2 = params[i,1], beta2 = params[i,2],Age_first_1 = 1, Age_first_2 = stage2 - (stage2-stage1)))
  (G2 <- Growth(alpha2 = params[i,1], beta2 = params[i,2],
                Age_first_1 = stage2 - (stage2-stage1), 
                Age_first_2 = stage2 + (stage2-stage1)))
  # Of the ones that survive, s_s[1], what proportion grow? 
  # t_ij <- matrix(c(s_s[1]-G, G,
  #                  f, s_s[2]-G2),
  t_ij <- matrix(c(s_s[1]-G, G,
                   f, s_s[2]-G2),
                 nrow = 2)
  (lambda1 <- lambda(t_ij))
  (e_ij <- popbio::elasticity(t_ij))
  survivalElast <- sum(e_ij[which(generic_mat == "L")])
  growthElast <- sum(e_ij[which(generic_mat == "G")])
  fecundElast <- sum(e_ij[which(generic_mat == "F")])
  listout <- list(t_ij,e_ij, data.frame(S = survivalElast, G = growthElast, R = fecundElast, lam = lambda1,
                                    gentim = generation.time(t_ij)))
  return(listout)
}
```


### ie. Silvertown et al 1996 "Interpretation of Elasticity Matrices as an aid to the managment of plant populations for conservation"
```{r}
generic_mat <- matrix(c("L","G",
                        "F","L"), nrow = 2)
# Stasis 
which(generic_mat == "L")
# Growth
which(generic_mat == "G")
# Fecundity
which(generic_mat == "F")
```

```{r}
params <- do.call(rbind, lapply(seq(0,0.7, by=0.01), function(a2){
  outb2 <- do.call(rbind, lapply(seq(0.1,1, by=0.01), function(b2){
    surv <- survivalTypeI(a2, b2, seq(0.5,30,by=0.5))
    data.frame(a2, b2, age = seq(0.5,30,by=0.5), survival = surv, a2b2 = paste(a2,b2,sep=""))
  }))
}))
```


# Iteroparous
```{r}
dev.off()
# params8 <- params[params$a2b2 %in%
#                     params$a2b2[params$survival < 0.95 & params$age == 1],]
# params8 <- params8[params8$a2b2 %in%
#                     params8$a2b2[
#                       params8$survival > (0.3) &
#                                    params8$survival < 0.8 & params8$age == 2],]
# params8 <- params8[params8$a2b2 %in%
#                     params8$a2b2[params8$survival > 0.25 &
#                                    params8$age == 6],]
# 
# params8 <- params8[!duplicated(params8[,c("a2","b2")]),]
# 
# params_itero <- params8
# save(params_itero, file = "C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/paramsIteroFast.Rdata")
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/paramsIteroFast.Rdata")

plot(0:26, survivalTypeI(params8[1,1], params8[1,2], 0:26), type = "l", col = rainbow(nrow(params8), alpha = 1)[1],
     # xlab = "",xaxt = "n", 
     xlab = "Age in years",
     ylab = "Survival (stasis)",
     ylim = c(0,1))
for(i in 2:nrow(params8)){
  lines(0:26, survivalTypeI(params8[i,1], params8[i,2], 0:26), type = "l", col = rainbow(nrow(params8), alpha = 1)[i])
}

# ------------------ Iteroparous fast ------------------------
# hist(rpois(100,2))
# max(rpois(1000,2))
set.seed(123)
itfast <- lapply(1:100, function(x){ 
  stage1 <- max(1,rpois(1,2))
  stage2 <- stage1 + max(1,rpois(1,2))
  MPM_itero(params_itero, stage1 = stage1, stage2 = stage2)
  })
MPMs_itfast <- lapply(itfast, function(x) x[[1]]) # The first item is the MPM
lamitfast <-data.frame(do.call(rbind, lapply(itfast, function(x) x[[3]])), parity = "itero", speed = "fast") 
median(lamitfast$lam)
mean(lamitfast$lam)
sd(lamitfast$lam)
generation.time(mean(MPMs_itfast))
```

```{r}
# ---------------------------------------------
# jpeg("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/IteroInitial_normalLambda.jpg",
#      width = 100, height = 100, units="mm", res = 300)

layout(matrix(c(1,2,3,4), 2,2),widths = c(6,2), heights = c(2,6))

  # Plot 1 density generation time
    den <- density(lamitfast$gentim)
    par(mar=c(0,4,0,0))
    plot(den$x, den$y, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red")
  # Plot 2 scatter plot
    par(mar=c(4,4,0,0))
    plot(lamitfast$gentim,lamitfast$lam, ylab = expression(lambda), xlab = "generation time",
         main = "", pch = 1, col = "red")
    mtext("a)", 3, line = 0.5,adj = 0)
  # Plot 3 blank
    frame()
  # Plot 4 lambda density
    den <- density(lamitfast$lam)
    par(mar=c(4,0,0,0))
    plot(den$y, den$x, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red")
    
# dev.off()
# ---------------------------------------------
```

```{r}
#Elasticities
Elasts_itfast <- data.frame(do.call(rbind,lapply(itfast, function(x) x[[3]])), 
                            parity = "iteroparous", speed = "fast")

# tern_itfast <-
 ggtern::ggtern(Elasts_itfast, aes(R, G, S, colour = lam))+ #, size = floor(gentim)))+ #, size = as.factor(floor(GenTime))))+ #lam))+
                  geom_point(shape = 16)+
                  scale_color_viridis_c(name = expression(lambda))+
   scale_size_continuous(name = "Generation time\n (years binned)")+
                  theme_showarrows()+
                  theme_clockwise()
              
```


# itero slow
```{r}
# ---------------------------- Iteroparous Slow ---------------------
# hist(rpois(100,5))
# max(rpois(1000,2))
# max(rpois(1000, 5))
set.seed(123)
itfast <- lapply(1:100, function(x){ 
  stage1 <- max(1,rpois(1,2))
  stage2 <- stage1 + max(1,rpois(1,5))
  MPM_itero(params_itero, stage1 = stage1, stage2 = stage2)
  })
itslow <- lapply(1:100, function(x) MPM_itero(params = params8slow, stage1 = stage1, stage2 = stage2))
MPMs_itslow <- lapply(itslow, function(x) x[[1]])

lamitslow <-data.frame(do.call(rbind, lapply(itslow, function(x) x[[3]])), parity = "itero", speed = "slow") 
median(lamitslow$lam)
mean(lamitslow$lam)
sd(lamitslow$lam)
generation.time(mean(MPMs_itslow))
mean(unlist(lapply(itslow, function(x) x[[3]]$gentim)))
```

```{r}
matrixmetrics <- do.call(rbind, list(lamitslow, lamitfast))

jpeg("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Itero_lambdagenerationtime.jpg",
     width = 100, height = 100, units="mm", res = 300)

    layout(matrix(c(1,2,3,4), 2,2),widths = c(6,2), heights = c(2,6))

    # Plot 1 density generation time
      den <- density(matrixmetrics$gentim[matrixmetrics$speed == "fast"])
      denslow <- density(matrixmetrics$gentim[matrixmetrics$speed == "slow"])
      par(mar=c(0,4,0,0))
      plot(den$x, den$y, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red",
           xlim = c(min(c(den$x, denslow$x)), max(c(den$x, denslow$x))),
           ylim = c(min(c(den$y, denslow$y)), max(c(den$y, denslow$y))))
      lines(denslow$x,denslow$y, col = "grey70",
           xlim = c(min(c(den$x, denslow$x)), max(c(den$x, denslow$x))),
           ylim = c(min(c(den$y, denslow$y)), max(c(den$y, denslow$y))))
    # Plot 2 scatter plot
      par(mar=c(4,4,0,0))
      plot(lamitslow$gentim,lamitslow$lam, ylab = expression(lambda), xlab = "generation time",
           main = "", pch = 16, col = "red",
           xlim = c(min(lamitslow$gentim, lamitfast$gentim),max(lamitslow$gentim, lamitfast$gentim)),
           ylim = c(min(lamitslow$lam, lamitfast$lam),max(lamitslow$lam, lamitfast$lam)))
      points(lamitfast$gentim, lamitfast$lam, pch = 2, col = "grey70")
      legend("topright", legend = c("slow","fast"), col = c("red","grey70"), pch = c(16,2))
      mtext("a)", 3, line = 0.5,adj = 0)
    # Plot 3 blank
      frame()
    # Plot 4 lambda density
      denlamfast <- density(matrixmetrics$lam[matrixmetrics$speed == "fast"])
      denlamslow <- density(matrixmetrics$lam[matrixmetrics$speed == "slow"])
      par(mar=c(4,0,0,0))
      plot(denlamfast$y, denlamfast$x, xlab = "",ylab="", main="", 
           xaxt = "n", yaxt = "n", type = "l",bty="n", col = "grey70",
           ylim = c(min(c(denlamfast$x, denlamslow$x)), max(c(denlamfast$x, denlamslow$x))),
           xlim = c(min(c(denlamfast$y, denlamslow$y)), max(c(denlamfast$y, denlamslow$y))))
      lines(denlamslow$y, denlamslow$x, col = "red")

dev.off()
# ---------------------------------------------
```

```{r}
# Elasticities
Elasts_itslow <- data.frame(do.call(rbind,lapply(itslow, function(x) x[[3]])), 
                            parity = "iteroparous", speed = "slow")
ggtern::ggtern(Elasts_itslow, aes(R, G, S, colour = lam))+
  geom_point()+
  scale_color_viridis_c(name = expression(lambda))+
  theme_showarrows()+
  theme_clockwise()

IteroAll <- rbind(Elasts_itfast,Elasts_itslow)

ternItero <- ggtern::ggtern(IteroAll, aes(R, G, S, colour = lam, shape = speed))+ #interaction(speed,parity)))+
            geom_point()+
            scale_color_viridis_c(name = expression(lambda))+
            scale_shape_manual(name = "Speed and\n parity", values = c(16,2))+
            theme_showarrows()+
            theme_clockwise()
ggsave(filename =  "C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/TernaryItero.jpg",
       ternItero,
       width=130, height=70,units='mm', dpi=300)
       
```

```{r}


#Test
# params <- params_semel
# (stage1 <- max(3,rpois(1,3)))
# (stage2 <- (stage1*2)+1)
### Semelparous ----------------------------------------------
MPM_semel <- function(params, stage1, stage2){
  # three juvenile stages, one reproductive
  i <- sample(1:nrow(params),1)
  (s_s <- survivalTypeI(alpha2 = params[i,1], beta2 = params[i,2], c(stage1,stage2))) 
  # (f <- rnorm(1,semel_fecundsurv(s_s[2]),0.01))
  f <- semel_fecundsurv(s_s[2])
  (G <- Growth(alpha2 = params[i,1], beta2 = params[i,2],Age_first_1 = 1, Age_first_2 = stage2))
  t_ij <- matrix(c(s_s[1], G,
                   f,      0),
                 nrow = 2)
  print(colSums(t_ij))
  (lambda1 <- lambda(t_ij))
  (e_ij <- popbio::elasticity(t_ij))
  survivalElast <- sum(e_ij[which(generic_mat == "L")])
  growthElast <- sum(e_ij[which(generic_mat == "G")])
  fecundElast <- sum(e_ij[which(generic_mat == "F")])
  listout <- list(t_ij,e_ij, data.frame(S = survivalElast, G = growthElast, R = fecundElast, lam = lambda1,
                                    gentim = generation.time(t_ij)))
  return(listout)
}
```

params_semel <- params[params$a2b2 %in%
                      params$a2b2[params$survival < 0.8 & params$age == 1],] # an annual reproductive at stage 1

params_semel <- params_semel[params_semel$a2b2 %in%
                               params_semel$a2b2[params_semel$survival > 0.05 &
                                                   params_semel$age == 7],] # maximum short lived reproductive stage is 7
params_semel <- params_semel[!duplicated(params_semel[,c("a2","b2")]),]


# semel fast
```{r}
# reproductive stage middle < 0.8 sefastst3 = middle of stage
# reproductive stage ca. 0 
dev.off()
params_semel <- params[params$a2b2 %in%
                      params$a2b2[params$survival < 0.4 & # to keep all S + G below 1
                                    # params$survival > 0.69 &
                                    params$age == 2],] # an annual reproductive at stage 2 year 2, first is seed bank

# params_semel <- params_semel[params_semel$a2b2 %in%
#                                params_semel$a2b2[
#                                  # params_semel$survival < 0.8 &
#                                                    params_semel$survival > 0.001 &
#                                                    params_semel$age == 7],] # maximum short lived reproductive stage is 7
# params_semel <- params_semel[params_semel$a2b2 %in%
#                                params_semel$a2b2[params_semel$survival < 0.3 & params_semel$age == 8],]

# params_semel <- params_semel[params_semel$a2b2 %in%
#                                params_semel$a2b2[params_semel$survival > 0 &
#                                                    params_semel$survival < 0.5 & params_semel$age == 26],]
params_semel <- params_semel[!duplicated(params_semel[,c("a2","b2")]),]

# save(params_semel, file = "C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/paramsSemel.Rdata")

# load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/paramsSemel.Rdata")

plot(0:26, survivalTypeI(params_semel[1,1], params_semel[1,2], 0:26), type = "l", 
     col = rainbow(nrow(params_semel), alpha = 1)[1],
     # xlab = "",xaxt = "n", 
     xlab = "Age in years",
     ylab = "Survival (stasis)",
     ylim = c(0,1))
for(i in 2:nrow(params_semel)){
  lines(0:26, survivalTypeI(params_semel[i,1], params_semel[i,2], 0:26), type = "l", 
        col = rainbow(nrow(params_semel), alpha = 1)[i])
}

# max(rpois(1000,3))
# max(rpois(1000, 2))

# get 100 runs
set.seed(123)
sefast <- lapply(1:100, function(x){ 
  (stage2 <- max(2,rpois(1,2))) # 1:7 years
  # stage 1 is halfway from 1 to stage2
  (stage1 <- max(1,round((stage2-1)/2,0)))
  MPM_semel(params_semel, stage1 = stage1, stage2 = (stage2+1)) # because want really low survival to drive up fecudity
  })
MPMs_sefast <- lapply(sefast, function(x) x[[1]]) # The first item is the MPM
lamsefast <-data.frame(do.call(rbind, lapply(sefast, function(x) x[[3]])), parity = "semel", speed = "fast") 
median(lamsefast$lam)
mean(lamsefast$lam)
sd(lamsefast$lam)
generation.time(mean(MPMs_sefast))
```


```{r}
# ---------------------------------------------
layout(matrix(c(1,2,3,4), 2,2),widths = c(6,2), heights = c(2,6))

  # Plot 1 density generation time
    den <- density(lamsefast$gentim)
    par(mar=c(0,4,0,0))
    plot(den$x, den$y, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red")
  # Plot 2 scatter plot
    par(mar=c(4,4,0,0))
    plot(lamsefast$gentim,lamsefast$lam, ylab = expression(lambda), xlab = "generation time",
         main = "", pch = 1, col = "red")
    mtext("a) semelparous fast", 3, line = 0.5,adj = 0)
  # Plot 3 blank
    frame()
  # Plot 4 lambda density
    den <- density(lamsefast$lam)
    par(mar=c(4,0,0,0))
    plot(den$y, den$x, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red")
    
# dev.off()
# ---------------------------------------------
```

#Elasticities
```{r}
Elasts_sefast <- data.frame(do.call(rbind,lapply(sefast, function(x) x[[3]])), 
                            parity = "semelparous", speed = "fast")

Elasts_all <- do.call(rbind, list(Elasts_itfast, Elasts_itslow, Elasts_sefast))
 ggtern::ggtern(Elasts_sefast, aes(R, G, S, colour = lam))+ 
                  geom_point(shape = 1)+
                  scale_color_viridis_c(name = expression(lambda))+
   scale_size_continuous(name = "Generation time\n (years binned)")+
                  theme_showarrows()+
                  theme_clockwise()

  ggtern::ggtern(Elasts_all, aes(R, G, S, colour = lam, shape = (interaction(speed, parity))))+ 
                  geom_point()+
                  scale_color_viridis_c(name = expression(lambda))+
   scale_shape_manual(name = "Generation time\n (years binned)",
                       values = 1:3)+
                  theme_showarrows()+
                  theme_clockwise()
              
```


# ---------------------------------------------
```{r}
jpeg("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/SurvivalStasisFig1a.jpg",
     width = 250, height = 100, units="mm", res = 300)

layout(matrix(c(1:3),1,3, byrow=TRUE), widths = c(3,3,3), heights = c(2))
#### Iteroparous ---------------------------------
par(mar = c(2,4,2,0))
plot(0:26, survivalTypeI(params_itero[1,1], params_itero[1,2], 0:26), type = "l", col = rainbow(nrow(params_itero), alpha = 1)[1],
     # xlab = "",xaxt = "n",
     xlab = "Age in years",
     ylab = "Survival (stasis)",
     ylim = c(0,1))
for(i in 2:nrow(params_itero)){
  lines(0:26, survivalTypeI(params_itero[i,1], params_itero[i,2], 0:26), type = "l", col = rainbow(nrow(params_itero), alpha = 1)[i])
}
mtext("a) iteroparous", adj=0)

#### semelparous ---------------------------------
par(mar = c(2,2,2,1))
plot(0:26, survivalTypeI(params_semel[1,1], params_semel[1,2], 0:26), type = "l", col = rainbow(nrow(params_semel), alpha = 1)[1],
     xlab = "Age (years)", ylab = "", yaxt = "n",
     ylim = c(0,1))
for(i in 2:nrow(params_semel)){
  lines(0:26, survivalTypeI(params_semel[i,1], params_semel[i,2], 0:26), type = "l", 
        col = rainbow(nrow(params_semel), alpha = 1)[i])
}
mtext("b) semelparous", adj=0)

# Plot 3
par(mar=c(4,3,2,2))
plot(seq(0,1,by=0.1), xlim = c(0,0.8), ylim = c(0,10), semel_fecundsurv(seq(0,1,by=0.1)), type = "l", 
     ylab = "Fecundity (R)", xlab = expression("Adult survival (S"[22]~")"))
lines(seq(0,1,by=0.1), itero_fecundsurv(seq(0,1,by=0.1)))
text(0.6,7, "iteroparous")
text(0.2,3, "semelparous")
mtext("c)", side = 3, adj = 0)


dev.off() 
# ----------------------------
# ----------------------------
# ----------------------------
```

# Semel slow
```{r}
# ---------------------------- Semelparous Slow ---------------------
hist(rpois(100,5))
max(rpois(1000,2))
max(rpois(1000, 6)) # at most semel slow will reproduce and die at age 16+stage 1
set.seed(123)
seslow <- lapply(1:100, function(x){ 
  stage1 <- max(1,rpois(1,2))
  stage2 <- stage1 + max(1,rpois(1,5))
  MPM_itero(params_itero, stage1 = stage1, stage2 = stage2)
  })
itslow <- lapply(1:100, function(x) MPM_itero(params = params8slow, stage1 = stage1, stage2 = stage2))
MPMs_itslow <- lapply(itslow, function(x) x[[1]])

lamitslow <-data.frame(do.call(rbind, lapply(itslow, function(x) x[[3]])), parity = "itero", speed = "slow") 
median(lamitslow$lam)
mean(lamitslow$lam)
sd(lamitslow$lam)
generation.time(mean(MPMs_itslow))
mean(unlist(lapply(itslow, function(x) x[[3]]$gentim)))
```

```{r}
matrixmetrics <- do.call(rbind, list(lamitslow, lamitfast))

jpeg("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Itero_lambdagenerationtime.jpg",
     width = 100, height = 100, units="mm", res = 300)

    layout(matrix(c(1,2,3,4), 2,2),widths = c(6,2), heights = c(2,6))

    # Plot 1 density generation time
      den <- density(matrixmetrics$gentim[matrixmetrics$speed == "fast"])
      denslow <- density(matrixmetrics$gentim[matrixmetrics$speed == "slow"])
      par(mar=c(0,4,0,0))
      plot(den$x, den$y, xlab = "",ylab="", main="", xaxt = "n", yaxt = "n", type = "l",bty="n", col = "red",
           xlim = c(min(c(den$x, denslow$x)), max(c(den$x, denslow$x))),
           ylim = c(min(c(den$y, denslow$y)), max(c(den$y, denslow$y))))
      lines(denslow$x,denslow$y, col = "grey70",
           xlim = c(min(c(den$x, denslow$x)), max(c(den$x, denslow$x))),
           ylim = c(min(c(den$y, denslow$y)), max(c(den$y, denslow$y))))
    # Plot 2 scatter plot
      par(mar=c(4,4,0,0))
      plot(lamitslow$gentim,lamitslow$lam, ylab = expression(lambda), xlab = "generation time",
           main = "", pch = 16, col = "red",
           xlim = c(min(lamitslow$gentim, lamitfast$gentim),max(lamitslow$gentim, lamitfast$gentim)),
           ylim = c(min(lamitslow$lam, lamitfast$lam),max(lamitslow$lam, lamitfast$lam)))
      points(lamitfast$gentim, lamitfast$lam, pch = 2, col = "grey70")
      legend("topright", legend = c("slow","fast"), col = c("red","grey70"), pch = c(16,2))
      mtext("a)", 3, line = 0.5,adj = 0)
    # Plot 3 blank
      frame()
    # Plot 4 lambda density
      denlamfast <- density(matrixmetrics$lam[matrixmetrics$speed == "fast"])
      denlamslow <- density(matrixmetrics$lam[matrixmetrics$speed == "slow"])
      par(mar=c(4,0,0,0))
      plot(denlamfast$y, denlamfast$x, xlab = "",ylab="", main="", 
           xaxt = "n", yaxt = "n", type = "l",bty="n", col = "grey70",
           ylim = c(min(c(denlamfast$x, denlamslow$x)), max(c(denlamfast$x, denlamslow$x))),
           xlim = c(min(c(denlamfast$y, denlamslow$y)), max(c(denlamfast$y, denlamslow$y))))
      lines(denlamslow$y, denlamslow$x, col = "red")

dev.off()
# ---------------------------------------------
```

```{r}
# Elasticities
Elasts_itslow <- data.frame(do.call(rbind,lapply(itslow, function(x) x[[3]])), 
                            parity = "iteroparous", speed = "slow")
ggtern::ggtern(Elasts_itslow, aes(R, G, S, colour = lam))+
  geom_point()+
  scale_color_viridis_c(name = expression(lambda))+
  theme_showarrows()+
  theme_clockwise()

IteroAll <- rbind(Elasts_itfast,Elasts_itslow)

ternItero <- ggtern::ggtern(IteroAll, aes(R, G, S, colour = lam, shape = speed))+ #interaction(speed,parity)))+
            geom_point()+
            scale_color_viridis_c(name = expression(lambda))+
            scale_shape_manual(name = "Speed and\n parity", values = c(16,2))+
            theme_showarrows()+
            theme_clockwise()
ggsave(filename =  "C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/TernaryItero.jpg",
       ternItero,
       width=130, height=70,units='mm', dpi=300)
       
```


# -------------------------- UPDATED TO HERE ---------------------
# -------------------------- UPDATED TO HERE ---------------------
# -------------------------- UPDATED TO HERE ---------------------



```{r}
# Methods ------ parameters parity and speed
(aggregate(survival ~ age, min, data = params[params$age %in% c(itfastst2,itfastst3)&
                                                           params$a2b2 %in% params8$a2b2,])) # Iteroparous fast
(aggregate(survival ~ age, max, data = params[params$age %in% c(itfastst2,itfastst3)&
                                                           params$a2b2 %in% params8$a2b2,]))
# ----------------
(aggregate(survival ~ age, min, data = params[params$age %in% c(sefastst2,sefastst3)&
                                                params$a2b2 %in% params_semel$a2b2,])) # semel fast
(aggregate(survival ~ age, max, data = params[params$age %in% c(sefastst2,sefastst3)&
                                                params$a2b2 %in% params_semel$a2b2,]))
# ----------------
(aggregate(survival ~ age, min, data = params[params$age %in% c(itslowst2,itslowst3)&
                                                params$a2b2 %in% params8slow$a2b2,])) # itero slow
(aggregate(survival ~ age, max, data = params[params$age %in% c(itslowst2,itslowst3)&
                                                params$a2b2 %in% params8slow$a2b2,]))
# ----------------
(aggregate(survival ~ age, min, data = params[params$age %in% c(seslowst2,seslowst3)&
                                                params$a2b2 %in% params_semelslow$a2b2,])) # semel slow
(aggregate(survival ~ age, max, data = params[params$age %in% c(seslowst2,seslowst3)&
                                                params$a2b2 %in% params_semelslow$a2b2,]))
# ----------------
```



      #Plot 3
      plot(1:4,1:4, axes = FALSE, xlab="",ylab="", type="n")
      for(i in 1:4){
        abline(v=i)
        abline(h=i)
      }
      text(1.5,3.5,"S")
      text(1.5,2.5, "G")
      text(1.5,1.5,"G")
      text(2.5,2.5, "S")
      text(2.5,1.5,"G")
      text(3.5,1.5,"R")



# Elasticity space, survival of the reproductive stage
```{r}
elast_type <- data.frame(R = c(0.3, 0.2, 0.7, 0.025, 0.2, 0.01, 0.25, 0.05, 0.9,  0.4, 0.05, 0.6, 0.49, 0.01, 0.98, 0.4),
                         G = c(0.5, 0.4, 0.29, 0.025, 0.7, 0.6,  0.7,  0.65,0.05, 0.5, 0.7,  0.5, 0.49, 0.01, 0.01, 0.4),
                         S = c(0.2, 0.5, 0.01, 0.95,  0.1, 0.39, 0.05, 0.3, 0.05, 0.6, 0.25, 0.4, 0.02, 0.98, 0.01, 0.2),
                         Type = c("semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous",
                                  "semelparous","iteroparous"))

ggsave(filename =  "C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/TernaryPlotConceptual.jpg",
       ggtern::ggtern(elast_type, aes(R, G, S, colour = Type, fill = Type))+ # colour = parity, shape = speed))+label = Type, 
         # geom_point(size = 30, shape = 2)+
         # scale_color_viridis_c()+
         # geom_text(size=3.5)+
         # geom_polygon()+
         geom_mean_ellipse()+
         theme_showarrows()+
         theme_clockwise()+
         ggtitle("d)")
         # theme(legend.position = "none")
       , width=100, height = 70, units = 'mm', dpi = 300)
```


Constrain lambda function
Step 1: make matrices from the functions above for
  a) survival across stages for a Type I survival curve,
  b) fecundity in relation to adult survival with a concave iteroparity and convex semelparity
  c) fast growth will be consistent over stages while slow will have slowed growth in larger/older stages
These will result in lambdas that should be around 1 since these are presumed viable life history options. However, to make them fair, want to get a range of lambdas around 1 for each (representing that within environmental context, some transtion matrices representing growing or shrinking populations - environment, intra- or inter-specific competition) but that contraining lambda will have an impact on elasticities and estimated generation time. Generation time impacts speed of response so speed of changing from a declining to stable or increasing population growth rate

```{r}
# --------------------- Annuals ------------------------
MPM_annual <- function(){
  # three seed stages, one reproductive
  i <- sample(1:nrow(paramlist_type1_semel),1)
  s_s <- survivalTypeIII(alpha1 = paramlist_fast[i,1],1:4, alpha3 = paramlist_fast[i,2], beta3 = paramlist_fast[i,3] )
  f <- fecunditysurvival(s_s[4])
  t_t <- survivalTypeI(alpha2 = 0.3,beta2 = 0.1, 1:4)
  t_t <- t_t/sum(t_t)
  t_ij <- matrix(c(0, s_s[1]*(2/3), 0,             s_s[1]*(1/3),
                   0, 0,            s_s[2]*(2/3),  s_s[2]*(1/3),
                   0, 0,            0,             s_s[3],
                   f, 0,            0,             0), 
                 nrow = 4)
  lambda1 <- lambda(t_ij)
  lambdarange <- abs(1-rnorm(1, 1, 0.1))
  # plot(seq(0.51,1.5,by=0.01), dnorm(seq(0.51,1.5,by=0.01), 1, 0.1))
  if(lambda1 > (1+lambdarange)) { # allow more or less variability by speed of life, more variable for fastest
    i <- mostelastic <- which(popbio::elasticity(t_ij) == max(popbio::elasticity(t_ij)))
    # secondmostelastic <- which(popbio::elasticity(t_ij) == sort(popbio::elasticity(t_ij), TRUE)[2])
    for(k in seq(0.1,0.5, by = 0.1)){
      t_ij[mostelastic] <- (1-k) * t_ij[mostelastic]
      # t_ij[secondmostelastic] <- (1-k) * t_ij[secondmostelastic]
      lambda1 <- lambda(t_ij)
      if(lambda1 <= (1+lambdarange)) break
      mostelastic <- which(popbio::elasticity(t_ij) == max(popbio::elasticity(t_ij))) # check if still same element
      if(mostelastic != i) break
    } # end reduction by k for loop of that element
  } # end while lambda is too big
  if(lambda(t_ij) < (1-lambdarange)){
    i <- mostelastic <- which(popbio::elasticity(t_ij) == max(popbio::elasticity(t_ij)))
    for(k in seq(1.1,1.5, by=0.1)){
      t_ij[mostelastic] <- k * t_ij[mostelastic]
      lambda1 <- lambda(t_ij)
      if(lambda1 >= (1-lambdarange)) break
      mostelastic <- which(popbio::elasticity(t_ij) == max(popbio::elasticity(t_ij))) # check if still same element
      if(mostelastic !=i) break
    } # end reduction by i for loop of that element
  } # end if lambda is too small
  return(t_ij)
}

MPMs_annual <- lapply(1:100, function(x) MPM_annual())
generation.time(mean(MPMs_annual))
hist(unlist(lapply(MPMs_annual, function(x) lambda(x))), xlab = "lambda", main = "Annual")




MPMs <- list(annual = MPM_annual, semelfast = MPM_semelfast, iterofast = MPM_iterofast,
             semelslow = MPM_semelslow, iteroslow = MPM_iteroslow)


# Testing
# Nxstages <- c(rep(NA,3),1)
# StartPopSize <- 10
# MatrixType <- "annual"
# repl <- 1
# rm(Nxstages); rm(StartPopSize); rm(MatrixType); rm(repl)

# ------------------------ Simulation of virtual species -----------------------------
# Modified from VirtualSpeciesSimulationLength_v2
virtualPVA <- function(Nxstages = rep(1,4), StartPopSize, MatrixType){
  dfout <- do.call(rbind,lapply(1:100, function(repl){
    # Take a sample of size at least 5, remove fecundity for TMx_list 
    Mx_sample <- lapply(1:100, function(i) MPMs[[grep(MatrixType, c("annual","semelfast","iterofast","semelslow","iteroslow"))]]())
    # calculate generation time to scale by generation time or set number of years for projection length
    gentim <- popbio::generation.time(mean(Mx_sample), r=1, c=4)
    projlength <- max(gentim*3, 100)
    # scale the above ground growth to the starting population size
    Nx <- stable.stage(mean(Mx_sample))
    Nx_scale <- Nx[!is.na(Nxstages)]
    vec1 <- matrix(floor(Nx*(StartPopSize/sum(Nx_scale))), ncol = 1)
    # Initilize for loop
    Extant <- c()
    yr <- c()
    mats <- list()
    popsz <- c()
    Time2Ext <- NA
    for(i in 1:projlength){
      yr[i] <- i
      mats[[i]] <- (sample(Mx_sample,1))[[1]]
      vec1 <- floor(mats[[i]]%*%vec1)
      popsz[i] <- sum(vec1[!is.na(Nxstages)])
      Extant[i] <- if(popsz[i]<1) 0 else 1
      if(Extant[i] == 0) Time2Ext <- i
      if(popsz[i] == 0) break
    }
    # A list of 2 or more, will be NA until second year
    if(length(popsz) > 2){
      if(length(popsz) < 6){
        lambdas <- do.call(rbind,lapply(seq(2,length(mats)), function(x){
          stochLambda <- popbio::stoch.growth.rate(mats[1:x], verbose = FALSE)
          data.frame(Year = x, Tulapprox = stochLambda$approx, LogGrowthsim = stochLambda$sim,
                     LogGrowthSimLowerCI = stochLambda$sim.CI[1], LogGrowthSimUpperCI = stochLambda$sim.CI[2])
        }))
      } else {
        lambdas <- do.call(rbind,lapply(seq(5,length(popsz),by = 5), function(x){
          stochLambda <- popbio::stoch.growth.rate(mats[1:x], verbose = FALSE)
          data.frame(Year = x, Tulapprox = stochLambda$approx, LogGrowthsim = stochLambda$sim,
                     LogGrowthSimLowerCI = stochLambda$sim.CI[1], LogGrowthSimUpperCI = stochLambda$sim.CI[2])
        }))
      }
    } else {
      lambdas <- data.frame(Year = yr, Tulapprox = unlist(lapply(mats, function(x) lambda(x))),
                            LogGrowthsim = NA, LogGrowthSimLowerCI = NA, LogGrowthSimUpperCI = NA)
    }
    dfMPM <- data.frame(PopSize = popsz, Year = yr, MatType = MatrixType, GenTime = gentim,
                        Extant = Extant, StPopSz = StartPopSize, Time2Extinction = Time2Ext, 
                        ProjectionLength = projlength, Replicate = repl)
    out <- merge(dfMPM, lambdas, by = "Year", all = TRUE)
    out
  }))
  dfout
}

# test 
Nxstages <- c(NA,NA,NA,1)
StartPopSize <- 10
MatrixType <- "annual"
# ------------------- Simulation runs ----------------------------
pathstartVirtual <-  "C:/Users/DePrengm/Denver Botanic Gardens/Conservation - Demography/SeedHarvestModelling/Seed_Harvest_Modeling/Simulation_output_virt_lambda_1/"

annuals <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(Nxstages = c(NA,NA,NA,1), StartPopSize = StPopSz, MatrixType = "annual" )
  save(out, file =  paste(pathstartVirtual,"annuals",StPopSz,".Rdata", sep=""))
  out
}))

iterofast <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(StartPopSize = StPopSz, MatrixType = "iterofast")
  save(out, file =  paste(pathstartVirtual,"iterofast",StPopSz,".Rdata", sep=""))
  out
}))

# error eigen(Abar) : non-square matrix in 'eigen'; Abar likely means mean(A) 
# When first thing went extinct, then mats[2:1] gave the one matrix and NULL 
iteroslow <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(StartPopSize = StPopSz, MatrixType = "iteroslow")
  save(out, file =  paste(pathstartVirtual,"iteroslow",StPopSz,".Rdata", sep=""))
  out
}))

semelfast <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(StartPopSize = StPopSz, MatrixType = "semelfast")
  save(out, file =  paste(pathstartVirtual,"semelfast",StPopSz,".Rdata", sep=""))
  out
}))

semelslow <- do.call(rbind,lapply(c(10,50,100,500), function(StPopSz){
  out <- virtualPVA(StartPopSize = StPopSz, MatrixType = "semelslow")
  save(out, file =  paste(pathstartVirtual,"semelslow",StPopSz,".Rdata", sep=""))
  out
}))

